{
    "name": "Solar Rosette Supabase (WORKING - usando $http)",
    "nodes": [
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "register",
                "responseMode": "responseNode"
            },
            "name": "Webhook Register",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 1.1,
            "position": [
                240,
                300
            ],
            "webhookId": "reg-hook"
        },
        {
            "parameters": {
                "functionCode": "// IMPORTANTE: N8N tiene $http disponible, NO fetch()\nconst body = items[0].json.body;\nconst SUPABASE_URL = 'https://vfbujngupbnvmlomzfgg.supabase.co';\nconst SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmYnVqbmd1cGJudm1sb216ZmdnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MDYwMzU3MCwiZXhwIjoyMDg2MTc5NTcwfQ.jNHJ-2N3STg9vlKXW8sV3knsfjwe4XQfhfaT-Mwob4M';\n\nconst headers = {\n  'apikey': SUPABASE_KEY,\n  'Authorization': `Bearer ${SUPABASE_KEY}`,\n  'Content-Type': 'application/json'\n};\n\ntry {\n  // Check if user exists\n  const checkUrl = `${SUPABASE_URL}/rest/v1/users?or=(cedula.eq.${body.cedula},email.eq.${encodeURIComponent(body.email)})&select=id`;\n  const checkRes = await $http.get(checkUrl, { headers });\n  \n  if (checkRes.length > 0) {\n    return [{\n      json: {\n        success: false,\n        message: 'La cedula o el correo electronico ya se encuentran registrados.'\n      }\n    }];\n  }\n\n  // Insert new user\n  const newUser = {\n    name: body.name,\n    email: body.email,\n    cedula: String(body.cedula),\n    phone: body.phone || '',\n    role: body.role || 'patient',\n    type: body.type || '',\n    registered_at: new Date().toISOString()\n  };\n\n  headers['Prefer'] = 'return=representation';\n  const insertRes = await $http.post(`${SUPABASE_URL}/rest/v1/users`, newUser, { headers });\n  \n  return [{\n    json: {\n      success: true,\n      user: insertRes[0]\n    }\n  }];\n} catch (e) {\n  return [{\n    json: {\n      success: false,\n      message: e.message || 'Error desconocido'\n    }\n  }];\n}"
            },
            "name": "Register Logic",
            "type": "n8n-nodes-base.function",
            "typeVersion": 1,
            "position": [
                460,
                300
            ]
        },
        {
            "parameters": {},
            "name": "Respond Register",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [
                680,
                300
            ]
        },
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "login",
                "responseMode": "responseNode"
            },
            "name": "Webhook Login",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 1.1,
            "position": [
                240,
                500
            ],
            "webhookId": "login-hook"
        },
        {
            "parameters": {
                "functionCode": "const body = items[0].json.body;\nconst SUPABASE_URL = 'https://vfbujngupbnvmlomzfgg.supabase.co';\nconst SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmYnVqbmd1cGJudm1sb216ZmdnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MDYwMzU3MCwiZXhwIjoyMDg2MTc5NTcwfQ.jNHJ-2N3STg9vlKXW8sV3knsfjwe4XQfhfaT-Mwob4M';\n\nconst headers = {\n  'apikey': SUPABASE_KEY,\n  'Authorization': `Bearer ${SUPABASE_KEY}`\n};\n\ntry {\n  let url = `${SUPABASE_URL}/rest/v1/users?cedula=eq.${body.cedula}&select=*`;\n  if (body.role) {\n    url += `&role=eq.${body.role}`;\n  }\n\n  const users = await $http.get(url, { headers });\n\n  if (users.length > 0) {\n    return [{ json: { success: true, user: users[0] } }];\n  }\n  return [{ json: { success: false, message: 'Usuario no encontrado' } }];\n} catch (e) {\n  return [{ json: { success: false, message: e.message } }];\n}"
            },
            "name": "Login Logic",
            "type": "n8n-nodes-base.function",
            "typeVersion": 1,
            "position": [
                460,
                500
            ]
        },
        {
            "parameters": {},
            "name": "Respond Login",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [
                680,
                500
            ]
        },
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "appointments",
                "responseMode": "responseNode"
            },
            "name": "Webhook Create Appt",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 1.1,
            "position": [
                240,
                700
            ],
            "webhookId": "create-appt-hook"
        },
        {
            "parameters": {
                "functionCode": "const body = items[0].json.body;\nconst SUPABASE_URL = 'https://vfbujngupbnvmlomzfgg.supabase.co';\nconst SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmYnVqbmd1cGJudm1sb216ZmdnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MDYwMzU3MCwiZXhwIjoyMDg2MTc5NTcwfQ.jNHJ-2N3STg9vlKXW8sV3knsfjwe4XQfhfaT-Mwob4M';\n\nconst headers = {\n  'apikey': SUPABASE_KEY,\n  'Authorization': `Bearer ${SUPABASE_KEY}`,\n  'Content-Type': 'application/json'\n};\n\ntry {\n  // Check for conflicts\n  const checkUrl = `${SUPABASE_URL}/rest/v1/appointments?date_str=eq.${body.dateStr}&time=eq.${encodeURIComponent(body.time)}&status=neq.CANCELADA&select=id`;\n  const conflicts = await $http.get(checkUrl, { headers });\n\n  if (conflicts.length > 0) {\n    return [{\n      json: {\n        success: false,\n        message: 'Lo sentimos, esta hora ya esta ocupada por otro paciente.'\n      }\n    }];\n  }\n\n  // Create appointment\n  const newAppt = {\n    patient_name: body.patientName,\n    patient_cedula: String(body.patientCedula),\n    date_str: body.dateStr,\n    time: body.time,\n    type: body.type || 'Cita',\n    status: 'PENDIENTE',\n    color: 'bg-orange'\n  };\n\n  headers['Prefer'] = 'return=representation';\n  const inserted = await $http.post(`${SUPABASE_URL}/rest/v1/appointments`, newAppt, { headers });\n\n  const mapped = inserted[0];\n  return [{\n    json: {\n      success: true,\n      appointment: {\n        id: mapped.id,\n        patientName: mapped.patient_name,\n        patientCedula: mapped.patient_cedula,\n        dateStr: mapped.date_str,\n        time: mapped.time,\n        type: mapped.type,\n        status: mapped.status,\n        color: mapped.color\n      }\n    }\n  }];\n} catch (e) {\n  return [{ json: { success: false, message: e.message } }];\n}"
            },
            "name": "Create Appt Logic",
            "type": "n8n-nodes-base.function",
            "typeVersion": 1,
            "position": [
                460,
                700
            ]
        },
        {
            "parameters": {},
            "name": "Respond Create Appt",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [
                680,
                700
            ]
        },
        {
            "parameters": {
                "path": "appointments",
                "responseMode": "responseNode"
            },
            "name": "Webhook Get Appts",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 1.1,
            "position": [
                240,
                900
            ],
            "webhookId": "get-appts-hook"
        },
        {
            "parameters": {
                "functionCode": "const query = items[0].json.query;\nconst userCedula = query.cedula;\nconst userRole = query.role;\nconst SUPABASE_URL = 'https://vfbujngupbnvmlomzfgg.supabase.co';\nconst SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmYnVqbmd1cGJudm1sb216ZmdnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MDYwMzU3MCwiZXhwIjoyMDg2MTc5NTcwfQ.jNHJ-2N3STg9vlKXW8sV3knsfjwe4XQfhfaT-Mwob4M';\n\nconst headers = {\n  'apikey': SUPABASE_KEY,\n  'Authorization': `Bearer ${SUPABASE_KEY}`\n};\n\ntry {\n  let url;\n  if (userRole === 'professional' || userRole === 'admin') {\n    url = `${SUPABASE_URL}/rest/v1/appointments?select=*`;\n  } else {\n    if (!userCedula) {\n      return [{ json: { success: true, appointments: [] } }];\n    }\n    url = `${SUPABASE_URL}/rest/v1/appointments?patient_cedula=eq.${userCedula}&select=*`;\n  }\n\n  const appts = await $http.get(url, { headers });\n\n  const mapped = appts.map(a => ({\n    id: a.id,\n    patientName: a.patient_name,\n    patientCedula: a.patient_cedula,\n    dateStr: a.date_str,\n    time: a.time,\n    type: a.type,\n    status: a.status,\n    color: a.color\n  }));\n\n  return [{ json: { success: true, appointments: mapped } }];\n} catch (e) {\n  return [{ json: { success: false, message: e.message } }];\n}"
            },
            "name": "Get Appts Logic",
            "type": "n8n-nodes-base.function",
            "typeVersion": 1,
            "position": [
                460,
                900
            ]
        },
        {
            "parameters": {},
            "name": "Respond Get Appts",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [
                680,
                900
            ]
        },
        {
            "parameters": {
                "path": "appointments/available-hours",
                "responseMode": "responseNode"
            },
            "name": "Webhook Available Hours",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 1.1,
            "position": [
                240,
                1100
            ],
            "webhookId": "avail-hours-hook"
        },
        {
            "parameters": {
                "functionCode": "const date = items[0].json.query.date;\nconst SUPABASE_URL = 'https://vfbujngupbnvmlomzfgg.supabase.co';\nconst SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmYnVqbmd1cGJudm1sb216ZmdnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MDYwMzU3MCwiZXhwIjoyMDg2MTc5NTcwfQ.jNHJ-2N3STg9vlKXW8sV3knsfjwe4XQfhfaT-Mwob4M';\n\nconst headers = {\n  'apikey': SUPABASE_KEY,\n  'Authorization': `Bearer ${SUPABASE_KEY}`\n};\n\ntry {\n  if (!date) {\n    return [{ json: { success: false, message: 'Falta fecha' } }];\n  }\n\n  const url = `${SUPABASE_URL}/rest/v1/appointments?date_str=eq.${date}&status=neq.CANCELADA&select=time`;\n  const occupiedAppts = await $http.get(url, { headers });\n  const occupied = occupiedAppts.map(a => a.time);\n\n  const allHours = [];\n  for (let h = 9; h <= 17; h++) {\n    allHours.push(h.toString().padStart(2, '0') + ':00');\n  }\n\n  const available = allHours.filter(h => occupied.indexOf(h) === -1);\n\n  return [{\n    json: {\n      success: true,\n      date: date,\n      availableHours: available,\n      occupiedHours: occupied,\n      totalSlots: allHours.length,\n      availableSlots: available.length\n    }\n  }];\n} catch (e) {\n  return [{ json: { success: false, message: e.message } }];\n}"
            },
            "name": "Available Hours Logic",
            "type": "n8n-nodes-base.function",
            "typeVersion": 1,
            "position": [
                460,
                1100
            ]
        },
        {
            "parameters": {},
            "name": "Respond Available Hours",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [
                680,
                1100
            ]
        }
    ],
    "connections": {
        "Webhook Register": {
            "main": [
                [
                    {
                        "node": "Register Logic",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Register Logic": {
            "main": [
                [
                    {
                        "node": "Respond Register",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Webhook Login": {
            "main": [
                [
                    {
                        "node": "Login Logic",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Login Logic": {
            "main": [
                [
                    {
                        "node": "Respond Login",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Webhook Create Appt": {
            "main": [
                [
                    {
                        "node": "Create Appt Logic",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Create Appt Logic": {
            "main": [
                [
                    {
                        "node": "Respond Create Appt",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Webhook Get Appts": {
            "main": [
                [
                    {
                        "node": "Get Appts Logic",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Appts Logic": {
            "main": [
                [
                    {
                        "node": "Respond Get Appts",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Webhook Available Hours": {
            "main": [
                [
                    {
                        "node": "Available Hours Logic",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Available Hours Logic": {
            "main": [
                [
                    {
                        "node": "Respond Available Hours",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "active": false,
    "settings": {},
    "versionId": "supabase-http-working",
    "id": "SupabaseHTTPWorking"
}