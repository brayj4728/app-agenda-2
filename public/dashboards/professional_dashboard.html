<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Professional Dashboard - Solar Rosette</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-app: #FFFFFF;
            --text-main: #000000;
            --text-gray: #8E8E93;
            --pill-active-bg: #000000;
            --pill-active-text: #FFFFFF;
            --pill-inactive-bg: #E5E5EA;
            --pill-inactive-text: #8E8E93;
            --hero-left-bg: #1C1C1E;
            --hero-right-bg: #4466C6;
            --card-bg: #F2F2F7;
            --card-text: #000000;
            --border-color: #E5E5EA;
            --bar-color: #8E8E93;
        }

        .dark-mode {
            --bg-app: #000000;
            --text-main: #FFFFFF;
            --text-gray: #8E8E93;
            --pill-active-bg: #FFFFFF;
            --pill-active-text: #000000;
            --pill-inactive-bg: #1C1C1E;
            --pill-inactive-text: #8E8E93;
            --hero-left-bg: #1C1C1E;
            --hero-right-bg: #4466C6;
            --card-bg: #1C1C1E;
            --card-text: #FFFFFF;
            --border-color: #2C2C2E;
            --bar-color: #48484A;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body {
            background-color: #f0f2f5;
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
        }

        .app-container {
            width: 100%;
            height: 100%;
            background-color: var(--bg-app);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        @media (min-width: 500px) {
            .app-container {
                max-width: 400px;
                max-height: 850px;
                height: 95vh;
                border-radius: 30px;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
                border: 1px solid var(--border-color);
            }
        }

        .scroll-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 30px;
            scrollbar-width: none;
        }

        .scroll-content::-webkit-scrollbar {
            display: none;
        }

        /* HEADER */
        .top-bar {
            padding: 40px 24px 10px 24px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .user-name {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-main);
            letter-spacing: -0.5px;
        }

        .controls-row {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .segmented-control {
            display: flex;
            gap: 8px;
            width: 100%;
            justify-content: space-between;
        }

        .filter-pill {
            padding: 10px 16px;
            border-radius: 14px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            flex: 1;
            text-align: center;
            white-space: nowrap;
        }

        .filter-pill.active {
            background: var(--pill-active-bg);
            color: var(--pill-active-text);
        }

        .filter-pill.inactive {
            background: var(--pill-inactive-bg);
            color: var(--pill-inactive-text);
        }

        /* HERO DATE CARD */
        .hero-date-card {
            margin: 10px 24px 20px 24px;
            height: 160px;
            display: flex;
            border-radius: 40px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .hero-left {
            flex: 1.2;
            background: var(--hero-left-bg);
            padding: 24px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            color: #FFFFFF;
        }

        .hero-day-name {
            font-size: 16px;
            font-weight: 400;
            opacity: 0.8;
            text-transform: lowercase;
        }

        .hero-ym {
            font-size: 18px;
            font-weight: 600;
            margin-top: 2px;
        }

        .hero-month-big {
            font-size: 64px;
            font-weight: 900;
            line-height: 0.9;
            letter-spacing: -2px;
            text-transform: uppercase;
        }

        .hero-right {
            flex: 1;
            background: var(--hero-right-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #FFFFFF;
        }

        .hero-time {
            font-size: 26px;
            font-weight: 400;
            text-align: center;
            line-height: 1.1;
        }

        /* STAT CARDS */
        .stats-list {
            padding: 0 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 30px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            color: var(--card-text);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .stat-title-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.pending {
            background: #FF9500;
        }

        .status-dot.approved {
            background: #34C759;
        }

        .status-dot.cancelled {
            background: #FF3B30;
        }

        .stat-label {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-main);
        }

        .stat-count {
            text-align: right;
        }

        .count-num {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-main);
        }

        .count-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-main);
            margin-left: 4px;
        }

        /* BAR CHART */
        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 60px;
            gap: 8px;
            padding: 0 5px;
        }

        .bar {
            flex: 1;
            background: var(--bar-color);
            border-radius: 10px;
            min-height: 10px;
            transition: height 0.5s ease;
        }

        .bar.active {
            background: #FFFFFF;
        }

        .dark-mode .bar.active {
            background: #FFFFFF;
        }

        /* CALENDAR STYLES */
        .cal-month-block {
            margin-bottom: 30px;
            padding: 0 24px;
        }

        .cal-month-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 15px;
            text-transform: capitalize;
        }

        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .cal-head {
            text-align: center;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-gray);
            padding-bottom: 8px;
        }

        .cal-cell {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-main);
            background: var(--card-bg);
            border-radius: 12px;
            position: relative;
        }

        .cal-cell.today {
            background: var(--hero-right-bg);
            color: #FFFFFF;
        }

        .dots-row {
            display: flex;
            gap: 2px;
            margin-top: 2px;
            position: absolute;
            bottom: 4px;
        }

        .dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
        }

        .dot.orange {
            background: #FF9500;
        }

        .dot.green {
            background: #34C759;
        }

        .dot.red {
            background: #FF3B30;
        }

        /* EXIT BUTTON */
        .tab-bar {
            padding: 20px 24px 40px 24px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-app);
            display: flex;
            justify-content: center;
            flex-shrink: 0;
        }

        .exit-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            color: var(--text-gray);
            font-size: 11px;
            font-weight: 600;
        }

        .exit-btn svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 3;
        }

        .hidden {
            display: none;
        }

        /* PACIENTES VIEW */
        .patient-list {
            padding: 0 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .patient-card {
            background: var(--card-bg);
            padding: 16px 20px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--text-main);
            cursor: pointer;
        }

        .patient-info h4 {
            font-size: 15px;
            font-weight: 700;
        }

        .patient-info p {
            font-size: 12px;
            color: var(--text-gray);
        }

        .action-arrow {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: #E5E5EA;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dark-mode .action-arrow {
            background: #2C2C2E;
        }

        /* NEW PATIENT ROW STYLES (Figma based) */
        .patient-row-premium {
            background: #000000;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: #FFFFFF;
        }

        .dark-mode .patient-row-premium {
            background: #1C1C1E;
            border: 1px solid #2C2C2E;
        }

        .p-info-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .p-name {
            font-size: 15px;
            font-weight: 700;
        }

        .p-sub {
            font-size: 11px;
            opacity: 0.7;
        }

        .p-time-group {
            text-align: center;
        }

        .p-time {
            font-size: 15px;
            font-weight: 500;
        }

        .p-date {
            font-size: 11px;
            opacity: 0.7;
        }

        .p-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn-action {
            width: 28px;
            height: 32px;
            border-radius: 6px;
            border: none;
            color: #FFFFFF;
            font-weight: 800;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-a {
            background: #34C759;
        }

        .btn-p {
            background: #FF9500;
        }

        .btn-c {
            background: #FF3B30;
        }

        .btn-wa {
            background: transparent;
            padding: 0;
            width: 32px;
            height: 32px;
            border: none;
            cursor: pointer;
        }

        .btn-wa img {
            width: 100%;
            height: 100%;
        }

        /* PROFILE SPECIFIC */
        .prof-status-pill {
            padding: 6px 14px;
            border-radius: 20px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            min-width: 90px;
            text-align: center;
        }

        .history-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .history-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notes-area {
            width: 100%;
            height: 120px;
            background: #E5E5EA;
            border: none;
            border-radius: 12px;
            padding: 16px;
            margin-top: 10px;
            font-size: 14px;
            resize: none;
            font-family: inherit;
        }

        .dark-mode .notes-area {
            background: #2C2C2E;
            color: white;
        }

        /* PROFILE OVERLAY */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-app);
            z-index: 1000;
            display: none;
            flex-direction: column;
        }

        .overlay.active {
            display: flex;
        }

        .overlay-header {
            padding: 40px 24px 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .back-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--pill-inactive-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-main);
            /* Default color */
        }

        /* Dark mode: Icons (svg) inside back-circle should be blue */
        .dark-mode .back-circle {
            color: var(--hero-right-bg);
            /* Blue */
            background: rgba(255, 255, 255, 0.1);
            /* Slight background for contrast if needed, or keep transparent/dark */
        }

        .overlay-content {
            flex: 1;
            overflow-y: auto;
            padding: 0 24px 40px;
        }

        /* HISTORY & NOTES OVERLAY STYLES */
        .history-full-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .dark-mode .history-full-item {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-pill-mockup {
            padding: 6px 12px;
            border-radius: 20px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            min-width: 80px;
            text-align: center;
        }

        .status-pill-mockup.cancelada {
            background: #FF3B30;
        }

        .status-pill-mockup.realizada {
            background: #34C759;
        }

        .mockup-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .notes-container-mockup {
            background: transparent;
            border-radius: 12px;
            padding: 0;
            min-height: auto;
            margin-bottom: 15px;
        }

        .dark-mode .notes-container-mockup {
            background: transparent;
        }

        .note-card-mockup {
            padding: 16px;
            background: #E5E5EA;
            border-radius: 12px;
            margin-bottom: 10px;
            font-size: 14px;
            color: var(--text-main);
            border: 1px solid var(--border-color);
        }

        .dark-mode .note-card-mockup {
            background: #2C2C2E;
            color: white;
            border: 1px solid #3A3A3C;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- HEADER -->
        <div class="top-bar">
            <h1 class="user-name" id="userName">Brayan Rojas</h1>
            <div class="controls-row">
                <div class="segmented-control">
                    <button class="filter-pill active" onclick="setTab('todo')">Todo</button>
                    <button class="filter-pill inactive" onclick="setTab('pacientes')">Pacientes</button>
                    <button class="filter-pill inactive" onclick="setTab('calendario')">Calendario</button>
                </div>
            </div>
        </div>

        <!-- HERO DATE CARD -->
        <div class="hero-date-card">
            <div class="hero-left">
                <div class="hero-day-name" id="headDay">lunes</div>
                <div class="hero-ym" id="headYM">2026/12</div>
                <div class="hero-month-big" id="headBigMon">DEC</div>
            </div>
            <div class="hero-right">
                <div class="hero-time" id="headTime">01:40 PM</div>
            </div>
        </div>

        <!-- SCROLLABLE CONTENT -->
        <div class="scroll-content">
            <!-- TODO VIEW -->
            <div id="todoView">
                <div class="stats-list">
                    <!-- Stat Card: Pending -->
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title-group">
                                <div class="status-dot pending"></div>
                                <span class="stat-label">Pendientes</span>
                            </div>
                            <div class="stat-count">
                                <span class="count-num" id="pendingCount">0</span>
                                <span class="count-text">Citas</span>
                            </div>
                        </div>
                        <div class="bar-chart" id="chartPending">
                            <!-- Bars injected by JS -->
                        </div>
                    </div>
                    <!-- Stat Card: Approved -->
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title-group">
                                <div class="status-dot approved"></div>
                                <span class="stat-label">Aprobadas</span>
                            </div>
                            <div class="stat-count">
                                <span class="count-num" id="approvedCount">0</span>
                                <span class="count-text">Citas</span>
                            </div>
                        </div>
                        <div class="bar-chart" id="chartApproved">
                            <!-- Bars injected by JS -->
                        </div>
                    </div>
                    <!-- Stat Card: Cancelled -->
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title-group">
                                <div class="status-dot cancelled"></div>
                                <span class="stat-label">Canceladas</span>
                            </div>
                            <div class="stat-count">
                                <span class="count-num" id="cancelledCount">0</span>
                                <span class="count-text">Citas</span>
                            </div>
                        </div>
                        <div class="bar-chart" id="chartCancelled">
                            <!-- Bars injected by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- PACIENTES VIEW -->
            <div id="pacientesView" class="hidden">
                <div class="patient-list" id="patientsListContainer">
                    <!-- Patients injected here -->
                </div>
            </div>

            <!-- CALENDARIO VIEW -->
            <div id="calendarioView" class="hidden">
            </div>
        </div>

        <!-- TAB BAR (BOTTOM) -->
        <div class="tab-bar">
            <div class="exit-btn" onclick="logout()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                <span>Salir</span>
            </div>
        </div>

        <!-- PROFILE OVERLAY -->
        <div id="profileOverlay" class="overlay">
            <div class="overlay-header">
                <div class="back-circle" onclick="closeProfile()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <path d="M15 18l-6-6 6-6" />
                    </svg>
                </div>
                <h2 style="font-size:24px; font-weight:800; color:var(--text-main);">Detalle Paciente</h2>
                <div class="back-circle" onclick="openHistoryNotes()" style="background:transparent; margin-left:auto;">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                </div>
            </div>

            <div class="overlay-content">
                <!-- Profile Summary -->
                <div style="display:flex; align-items:center; gap:16px; margin-bottom:30px;">
                    <div
                        style="width:56px; height:56px; background:#FF9500; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white;">
                        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                            <circle cx="12" cy="7" r="4" />
                        </svg>
                    </div>
                    <div>
                        <div id="profName" style="font-size:18px; font-weight:700; color:var(--text-main);">Paciente
                        </div>
                        <div id="profCedula" style="font-size:13px; color:var(--text-gray);">Cedula ...</div>
                    </div>
                </div>

                <!-- Appointments Management -->
                <div style="margin-bottom:30px;">
                    <h3 style="font-size:16px; font-weight:700; color:var(--text-main); margin-bottom:15px;">Gestión de
                        citas</h3>
                    <div id="historyList">
                        <!-- Appointment management rows injected here -->
                    </div>
                </div>

            </div>
        </div>

        <!-- HISTORY & NOTES OVERLAY MOVED INSIDE CONTAINER -->
        <div id="historyNotesOverlay" class="overlay">
            <div class="overlay-header">
                <div class="back-circle" onclick="closeHistoryNotes()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <path d="M15 18l-6-6 6-6" />
                    </svg>
                </div>
                <h2 style="font-size:24px; font-weight:800; color:var(--text-main);">Historial y Notas</h2>
            </div>
            <div class="overlay-content">
                <div style="margin-bottom:30px;">
                    <h3 style="font-size:16px; font-weight:700; color:var(--text-main); margin-bottom:15px;">Historial
                        de citas</h3>
                    <div id="fullHistoryContainer"></div>
                </div>

                <div>
                    <h3 style="font-size:16px; font-weight:700; color:var(--text-main); margin-bottom:10px;">Notas</h3>
                    <div id="fullNotesContainer" class="notes-container-mockup">
                        <!-- Notes list injected here -->
                    </div>

                    <textarea id="mockNotesInput" class="notes-area" placeholder="Añadir nueva nota..."></textarea>
                    <button onclick="saveMockNotes()"
                        style="width:100%; background:var(--hero-right-bg); color:white; border:none; padding:16px; border-radius:12px; font-weight:700; margin-top:12px; cursor:pointer;">Guardar
                        Nota</button>
                </div>
            </div>
        </div>
    </div>


    <script src="../config.js"></script>
    <script src="../supabase-client.js"></script>
    <script>
        let allAppointments = [];
        let currentUser = { name: 'Profesional', role: 'professional' };
        let pNotes = [];

        function init() {
            applyTheme();
            loadUserData();
            updateLiveClock();
            setInterval(updateLiveClock, 1000);
            loadData();
            setInterval(loadData, 30000); // Sync 30s
        }

        function applyTheme() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.classList.toggle('dark-mode', theme === 'dark');
        }

        function loadUserData() {
            try {
                const stored = localStorage.getItem('solarUser');
                if (stored && stored !== "undefined") {
                    currentUser = JSON.parse(stored);
                }
            } catch (e) { console.error(e); }
            document.getElementById('userName').textContent = currentUser.name || 'Profesional';
        }

        function updateLiveClock() {
            const now = new Date();
            const days = ['domingo', 'lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado'];
            const mons = ['ENE', 'FEB', 'MAR', 'ABR', 'MAY', 'JUN', 'JUL', 'AGO', 'SEP', 'OCT', 'NOV', 'DIC'];

            document.getElementById('headDay').textContent = days[now.getDay()];
            document.getElementById('headYM').textContent = `${now.getFullYear()}/${(now.getMonth() + 1).toString().padStart(2, '0')}`;
            document.getElementById('headBigMon').textContent = mons[now.getMonth()];

            let h = now.getHours(), m = now.getMinutes(), ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12 || 12;
            document.getElementById('headTime').textContent = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')} ${ampm}`;
        }

        async function loadData() {
            try {
                if (typeof SupabaseHelper === 'undefined') return;
                const data = await SupabaseHelper.getAppointments(null, 'professional');
                if (data.success && data.appointments) {
                    allAppointments = data.appointments;
                    renderDashboard();
                    renderPatients();
                    if (!document.getElementById('calendarioView').classList.contains('hidden')) {
                        renderCalendar();
                    }
                }
            } catch (e) { console.error(e); }
        }

        function renderDashboard() {
            let pending = 0, approved = 0, cancelled = 0;
            allAppointments.forEach(a => {
                const st = (a.status || '').toLowerCase();
                if (st.includes('aprob')) approved++;
                else if (st.includes('cancel')) cancelled++;
                else pending++;
            });

            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('approvedCount').textContent = approved;
            document.getElementById('cancelledCount').textContent = cancelled;

            renderChart('chartPending', 8);
            renderChart('chartApproved', 8);
            renderChart('chartCancelled', 8);
        }

        function renderChart(containerId, barCount) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            for (let i = 0; i < barCount; i++) {
                const bar = document.createElement('div');
                bar.className = 'bar';
                // Random height for visual effect as per screenshot
                const h = Math.floor(Math.random() * 50) + 10;
                bar.style.height = `${h}px`;
                if (i === 4) bar.classList.add('active'); // Middle bar highlighted
                container.appendChild(bar);
            }
        }

        function renderPatients() {
            const container = document.getElementById('patientsListContainer');
            if (!container) return;
            container.innerHTML = '';

            // Group by unique patient
            const uniquePatients = {};
            allAppointments.forEach(a => {
                if (!uniquePatients[a.patientCedula]) {
                    uniquePatients[a.patientCedula] = {
                        name: a.patientName,
                        cedula: a.patientCedula,
                        count: 0
                    };
                }
                uniquePatients[a.patientCedula].count++;
            });

            const sorted = Object.values(uniquePatients).sort((a, b) => b.count - a.count);

            sorted.forEach(p => {
                const row = document.createElement('div');
                row.className = 'patient-row-premium';
                row.onclick = () => openProfile(p.cedula, p.name);
                row.style.cursor = 'pointer';
                row.innerHTML = `
                    <div class="p-info-group">
                        <div class="p-name">${p.name}</div>
                        <div class="p-sub">Cédula ${p.cedula}</div>
                    </div>
                    <div class="p-time-group" style="text-align:right;">
                        <div class="p-time">${p.count}</div>
                        <div class="p-date">CITAS</div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        async function updateStatus(id, newStatus) {
            try {
                const res = await SupabaseHelper.updateAppointment(id, { status: newStatus });
                if (res.success) {
                    loadData();
                }
            } catch (e) { console.error(e); }
        }

        async function openWhatsApp(appointmentId) {
            const app = allAppointments.find(a => a.id == appointmentId);
            if (!app) return;

            try {
                const usersData = await SupabaseHelper.getAllUsers();
                const userRow = usersData.users.find(u => String(u.cedula) === String(app.patientCedula));
                if (!userRow || !userRow.phone) return alert("Paciente sin teléfono");

                let msg = '';
                if (app.status === 'APROBADA') msg = `Hola ${app.patientName}, tu cita ha sido APROBADA para el ${app.dateStr} a las ${app.time}.`;
                else if (app.status === 'CANCELADA') msg = `Hola ${app.patientName}, tu cita ha sido CANCELADA.`;
                else msg = `Hola ${app.patientName}, tu cita está PENDIENTE.`;

                window.open(`https://wa.me/${CONFIG.WHATSAPP_COUNTRY_CODE}${userRow.phone}?text=${encodeURIComponent(msg)}`, '_blank');
            } catch (e) { console.error(e); }
        }

        // PROFILE LOGIC
        let currentProfileCedula = null;

        async function openProfile(cedula, name) {
            currentProfileCedula = cedula;
            document.getElementById('profName').textContent = name;
            document.getElementById('profCedula').textContent = `Cédula ${cedula}`;
            document.getElementById('profileOverlay').classList.add('active');

            // Appointments List with Management (Image 3 design)
            const history = allAppointments.filter(a => String(a.patientCedula) === String(cedula));
            const container = document.getElementById('historyList');
            container.innerHTML = '';
            history.forEach(h => {
                const st = (h.status || 'PENDIENTE').toUpperCase();
                let color = '#FF9500'; // Orange
                let label = 'Pendiente';
                if (st.includes('APROB')) { color = '#34C759'; label = 'Aprobada'; }
                if (st.includes('CANCEL')) { color = '#FF3B30'; label = 'Cancelada'; }

                const div = document.createElement('div');
                div.className = 'patient-row-premium'; // Using same base class for consistency
                div.style.cssText = 'background:#000000; display:block; padding:16px; margin-bottom:12px; position:relative;';
                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:6px; margin-bottom:12px; font-size:12px; opacity:0.8;">
                        <div style="width:12px; height:12px; border-radius:50%; background:${color};"></div>
                        <span>${label}</span>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr auto; align-items:center; gap:10px;">
                        <div>
                            <div style="font-size:20px; font-weight:700;">${h.patientName}</div>
                            <div style="font-size:13px; opacity:0.6;">Cédula ${h.patientCedula}</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:22px; font-weight:500;">${h.time || '--:--'}</div>
                            <div style="font-size:12px; opacity:0.6;">${h.dateStr}</div>
                        </div>
                        <div style="display:flex; gap:6px; align-items:center;">
                            <button class="btn-action btn-a" onclick="updateStatusFromProfile('${h.id}', 'APROBADA')">A</button>
                            <button class="btn-action btn-p" onclick="updateStatusFromProfile('${h.id}', 'PENDIENTE')">P</button>
                            <button class="btn-action btn-c" onclick="updateStatusFromProfile('${h.id}', 'CANCELADA')">C</button>
                            <button class="btn-wa" onclick="openWhatsApp('${h.id}')" style="margin-left:4px;">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WA" style="width:32px; height:32px;">
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });

            // Notes
            // Notes removed from profile as per user request (Voice Note)
            // loadNotesForProfile(); // Disabled
        }



        async function updateStatusFromProfile(id, newStatus) {
            await updateStatus(id, newStatus);
            // Re-render only the profile content without closing it
            const storedName = document.getElementById('profName').textContent;
            openProfile(currentProfileCedula, storedName);
        }




        function renderCalendar() {
            const cv = document.getElementById('calendarioView');
            cv.innerHTML = '';
            const now = new Date();
            let mSet = new Set();
            mSet.add(`${now.getFullYear()}-${now.getMonth()}`);

            allAppointments.forEach(a => {
                if (a.dateStr) {
                    const [y, m] = a.dateStr.split('-');
                    mSet.add(`${y}-${parseInt(m) - 1}`);
                }
            });

            const months = Array.from(mSet).map(s => {
                const [y, m] = s.split('-');
                return { year: parseInt(y), month: parseInt(m) };
            }).sort((a, b) => (a.year * 12 + a.month) - (b.year * 12 + b.month));

            months.forEach(met => {
                const d = document.createElement('div');
                d.className = 'cal-month-block';
                const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                d.innerHTML = `<div class="cal-month-title">${monthNames[met.month]} ${met.year}</div>`;

                const g = document.createElement('div');
                g.className = 'cal-grid';
                ['D', 'L', 'M', 'M', 'J', 'V', 'S'].forEach(h => g.innerHTML += `<div class="cal-head">${h}</div>`);

                const firstDay = new Date(met.year, met.month, 1).getDay();
                const daysInMonth = new Date(met.year, met.month + 1, 0).getDate();
                for (let i = 0; i < firstDay; i++) g.innerHTML += '<div></div>';

                for (let i = 1; i <= daysInMonth; i++) {
                    const c = document.createElement('div');
                    c.className = 'cal-cell';
                    c.textContent = i;
                    if (met.year === now.getFullYear() && met.month === now.getMonth() && i === now.getDate()) c.classList.add('today');

                    const ds = `${met.year}-${(met.month + 1).toString().padStart(2, '0')}-${i.toString().padStart(2, '0')}`;
                    const ap = allAppointments.filter(a => a.dateStr === ds);

                    if (ap.length > 0) {
                        let h = '<div class="dots-row">';
                        ap.slice(0, 3).forEach(a => {
                            let cl = 'orange';
                            let s = (a.status || '').toLowerCase();
                            if (s.includes('aprob')) cl = 'green';
                            if (s.includes('cancel')) cl = 'red';
                            h += `<div class="dot ${cl}"></div>`;
                        });
                        h += '</div>';
                        c.innerHTML += h;
                    }
                    g.appendChild(c);
                }
                d.appendChild(g);
                cv.appendChild(d);
            });
        }

        function setTab(tab) {
            document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.filter-pill').forEach(p => {
                if (p.textContent.toLowerCase() === tab) p.classList.add('active');
            });

            document.getElementById('todoView').classList.add('hidden');
            document.getElementById('pacientesView').classList.add('hidden');
            document.getElementById('calendarioView').classList.add('hidden');

            if (tab === 'todo') document.getElementById('todoView').classList.remove('hidden');
            if (tab === 'pacientes') document.getElementById('pacientesView').classList.remove('hidden');
            if (tab === 'calendario') {
                document.getElementById('calendarioView').classList.remove('hidden');
                renderCalendar();
            }
        }

        function closeProfile() {
            document.getElementById('profileOverlay').classList.remove('active');
        }

        function logout() {
            localStorage.removeItem('solarUser');
            window.location.href = '../login.html';
        }

        init();
        // History & Notes Logic
        async function openHistoryNotes() {
            const historyOverlay = document.getElementById('historyNotesOverlay');
            historyOverlay.classList.add('active');

            const notesContainer = document.getElementById('fullNotesContainer');
            if (notesContainer) notesContainer.innerHTML = '<div style="text-align:center; padding:20px; opacity:0.6;">Cargando notas...</div>';

            // Fetch notes for this user
            try {
                if (currentProfileCedula) {
                    const usersData = await SupabaseHelper.getAllUsers();
                    const u = usersData.users.find(x => String(x.cedula) === String(currentProfileCedula));
                    let rawNotes = u && u.notes ? u.notes : [];
                    // Parse if it's a string (compatibility with text columns or buggy saves)
                    if (typeof rawNotes === 'string' && rawNotes.trim().startsWith('[')) {
                        try { rawNotes = JSON.parse(rawNotes); } catch (e) { console.error("Parse error:", e); }
                    }
                    pNotes = Array.isArray(rawNotes) ? rawNotes : (rawNotes ? [rawNotes] : []);
                }
            } catch (e) {
                console.error("Error fetching notes:", e);
                pNotes = [];
            }

            renderFullHistory();
            renderNotesInHistory();
        }

        function closeHistoryNotes() {
            document.getElementById('historyNotesOverlay').classList.remove('active');
        }

        function renderFullHistory() {
            const container = document.getElementById('fullHistoryContainer');
            if (!container) return;
            container.innerHTML = '';

            // Filter appointments for current profile
            const history = allAppointments.filter(a => String(a.patientCedula) === String(currentProfileCedula));

            history.forEach(h => {
                const st = (h.status || 'PENDIENTE').toUpperCase();
                let dotColor = '#FF9500';
                let pillClass = 'pendiente';
                let label = 'Pendiente';

                if (st.includes('APROB') || st.includes('REALIZ')) {
                    dotColor = '#34C759';
                    pillClass = 'realizada';
                    label = 'Realizada';
                } else if (st.includes('CANCEL')) {
                    dotColor = '#FF3B30';
                    pillClass = 'cancelada';
                    label = 'Cancelada';
                }

                const div = document.createElement('div');
                div.className = 'history-full-item';
                div.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        <span class="mockup-dot" style="background:${dotColor}"></span>
                        <div style="font-weight:600; color:var(--text-main); font-size:15px;">
                            ${h.dateStr || ''}
                        </div>
                    </div>
                    <div class="status-pill-mockup ${pillClass}">
                        ${label}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Local notes variable already defined above

        // Override loadUserData to fetch notes if needed, or rely on openProfile to set currentProfileCedula
        // currentProfileCedula is needed. It seems it wasn't defined global in the snippet I saw.
        // I should define it if it's missing or ensure openProfile sets it.

        function renderNotesInHistory() {
            const historyContainer = document.getElementById('fullNotesContainer');
            if (!historyContainer) return;

            if (!Array.isArray(pNotes) || pNotes.length === 0) {
                historyContainer.innerHTML = '<div style="text-align:center; padding:20px; opacity:0.5;">No hay notas registradas.</div>';
                return;
            }

            const html = pNotes.map((n, idx) => {
                let text = typeof n === 'string' ? n : (n.text || '');
                const date = n.date || '';

                // Final defense: if text still looks like JSON array, try to extract first item's text
                if (typeof text === 'string' && text.trim().startsWith('[{"')) {
                    try {
                        const parsed = JSON.parse(text);
                        if (Array.isArray(parsed) && parsed[0].text) text = parsed[0].text;
                    } catch (e) { }
                }
                const isPatient = text.startsWith("PACIENTE:");
                const displayLabel = isPatient ? "<b>NOTA DEL PACIENTE</b>" : "PROFESIONAL";
                const displayColor = isPatient ? "var(--hero-right-bg)" : "var(--text-gray)";
                const displayText = isPatient ? text.replace("PACIENTE: ", "") : text;

                return `
                    <div class="note-card-mockup" style="${isPatient ? 'border-left: 4px solid var(--hero-right-bg);' : ''}">
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:11px;">
                            <span style="color:${displayColor}; font-weight:700;">${displayLabel}</span>
                            <span style="opacity:0.6;">${date}</span>
                        </div>
                        <div style="font-size:14px; line-height:1.4;">${displayText}</div>
                        <div style="display:flex; justify-content:flex-end; margin-top:8px; gap:12px; font-size:11px;">
                            <span onclick="editNote(${idx})" style="cursor:pointer; color:var(--hero-right-bg); font-weight:600;">Editar</span>
                            <span onclick="deleteNote(${idx})" style="cursor:pointer; color:#FF3B30; font-weight:600;">Borrar</span>
                        </div>
                    </div>
                `;
            }).join('');

            historyContainer.innerHTML = html;
        }

        async function deleteNote(idx) {
            if (!confirm('¿Borrar nota?')) return;
            pNotes.splice(idx, 1);
            renderNotesInHistory();
            try {
                await SupabaseHelper.updateUser(currentProfileCedula, { notes: pNotes });
            } catch (e) { console.error(e); }
        }

        async function editNote(idx) {
            const currentText = typeof pNotes[idx] === 'string' ? pNotes[idx] : pNotes[idx].text;
            const newTxt = prompt('Editar nota:', currentText);
            if (newTxt === null) return;

            pNotes[idx] = { text: newTxt, date: new Date().toLocaleDateString() };
            renderNotesInHistory();
            try {
                await SupabaseHelper.updateUser(currentProfileCedula, { notes: pNotes });
            } catch (e) { console.error(e); }
        }

        async function saveMockNotes() {
            const txt = document.getElementById('mockNotesInput').value;
            if (!txt.trim()) return;
            saveGenericNote(txt);
            document.getElementById('mockNotesInput').value = '';
        }

        async function saveGenericNote(txt) {
            if (!Array.isArray(pNotes)) pNotes = [];
            pNotes.unshift({ text: txt, date: new Date().toLocaleDateString() });
            renderNotesInHistory();
            try {
                const cedula = String(currentProfileCedula);
                const res = await SupabaseHelper.updateUser(cedula, { notes: pNotes });
                if (!res.success) throw new Error(res.message);
            } catch (e) {
                console.error("Error al guardar nota:", e);
                alert("Error al guardar en la base de datos.");
            }
        }
    </script>
</body>

</html>